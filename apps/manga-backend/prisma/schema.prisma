// Prisma Schema for Manga Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Users & Authentication ====================

enum UserRole {
  USER
  TRANSLATOR
  EDITOR
  ADMIN
  SUPER_ADMIN
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String?  @map("password_hash")
  role          UserRole @default(USER)
  avatarUrl     String?  @map("avatar_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  favorites      Favorite[]
  readingHistory ReadingHistory[]
  comments       Comment[]
  issueReports   IssueReport[]
  articles       TeamArticle[]

  @@map("users")
}

// ==================== Manga ====================

enum MangaStatus {
  ONGOING
  COMPLETED
  HIATUS
}

model Manga {
  id            String       @id @default(uuid())
  slug          String       @unique
  titleAr       String       @map("title_ar")
  titleEn       String?      @map("title_en")
  description   String       @db.Text
  coverImageUrl String       @map("cover_image_url")
  author        String
  artist        String
  status        MangaStatus  @default(ONGOING)
  year          Int?
  ratingAvg     Float        @default(0) @map("rating_avg")
  totalViews    BigInt       @default(0) @map("total_views")
  isPublished   Boolean      @default(false) @map("is_published")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  genres         MangaGenre[]
  chapters       Chapter[]
  favorites      Favorite[]
  readingHistory ReadingHistory[]
  comments       Comment[]
  issueReports   IssueReport[]

  @@map("manga")
}

// ==================== Genres ====================

model Genre {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  manga MangaGenre[]

  @@map("genres")
}

model MangaGenre {
  mangaId String @map("manga_id")
  genreId String @map("genre_id")

  manga Manga @relation(fields: [mangaId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([mangaId, genreId])
  @@map("manga_genres")
}

// ==================== Chapters ====================

model Chapter {
  id            String    @id @default(uuid())
  mangaId       String    @map("manga_id")
  number        String    // Can be "1", "2", "Special", etc.
  title         String?
  slug          String    @unique
  isPublished   Boolean   @default(false) @map("is_published")
  isPremium     Boolean   @default(false) @map("is_premium")
  scheduledAt   DateTime? @map("scheduled_at")
  publishedAt   DateTime? @map("published_at")
  viewCount     BigInt    @default(0) @map("view_count")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  manga          Manga            @relation(fields: [mangaId], references: [id], onDelete: Cascade)
  pages          ChapterPage[]
  readingHistory ReadingHistory[]
  comments       Comment[]
  issueReports   IssueReport[]

  @@map("chapters")
}

// ==================== Chapter Pages ====================

model ChapterPage {
  id        String   @id @default(uuid())
  chapterId String   @map("chapter_id")
  pageIndex Int      @map("page_index")
  imageUrl  String   @map("image_url")
  width     Int?
  height    Int?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, pageIndex])
  @@map("chapter_pages")
}

// ==================== User Interactions ====================

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  mangaId   String   @map("manga_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  manga Manga @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@unique([userId, mangaId])
  @@map("favorites")
}

model ReadingHistory {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  mangaId       String   @map("manga_id")
  chapterId     String   @map("chapter_id")
  lastPageIndex Int?     @map("last_page_index")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  manga   Manga   @relation(fields: [mangaId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([userId, mangaId])
  @@map("reading_history")
}

// ==================== Comments ====================

enum CommentStatus {
  VISIBLE
  HIDDEN
  PENDING
}

model Comment {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  mangaId   String?       @map("manga_id")
  chapterId String?       @map("chapter_id")
  content   String        @db.Text
  status    CommentStatus @default(PENDING)
  createdAt DateTime      @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  manga   Manga?   @relation(fields: [mangaId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@map("comments")
}

// ==================== Issue Reports ====================

enum IssueType {
  MISSING_PAGE
  BROKEN_IMAGE
  TRANSLATION_ERROR
  OTHER
}

enum IssueStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

model IssueReport {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  mangaId   String      @map("manga_id")
  chapterId String      @map("chapter_id")
  pageIndex Int?        @map("page_index")
  type      IssueType
  message   String      @db.Text
  status    IssueStatus @default(NEW)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  manga   Manga   @relation(fields: [mangaId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@map("issue_reports")
}

// ==================== Team Articles ====================

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model TeamArticle {
  id            String        @id @default(uuid())
  slug          String        @unique
  title         String
  content       String        @db.Text
  coverImageUrl String?       @map("cover_image_url")
  authorId      String        @map("author_id")
  status        ArticleStatus @default(DRAFT)
  publishedAt   DateTime?     @map("published_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("team_articles")
}

// ==================== Site Settings ====================

enum DefaultTheme {
  DARK
  LIGHT
}

model SiteSetting {
  id                  Int          @id @default(1)
  siteName            String       @default("SwatApp Manga") @map("site_name")
  logoUrl             String?      @map("logo_url")
  faviconUrl          String?      @map("favicon_url")
  socialDiscordUrl    String?      @map("social_discord_url")
  socialTwitterUrl    String?      @map("social_twitter_url")
  registrationOpen    Boolean      @default(true) @map("registration_open")
  commentsEnabled     Boolean      @default(true) @map("comments_enabled")
  defaultTheme        DefaultTheme @default(DARK) @map("default_theme")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  @@map("site_settings")
}
